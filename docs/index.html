<!DOCTYPE html>

<html>
<head>
  <title>index.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>index.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/*!
 * hemera
 * Copyright(c) 2016 Dustin Deus (deusdustin@gmail.com)
 * MIT Licensed
 */</span><span class="hljs-meta">

'use strict'</span>

<span class="hljs-comment">/**
 * Module Dependencies
 */</span>

<span class="hljs-keyword">const</span>
  EventEmitter = <span class="hljs-built_in">require</span>(<span class="hljs-string">'events'</span>),
  Kilt = <span class="hljs-built_in">require</span>(<span class="hljs-string">'kilt'</span>),
  Bloomrun = <span class="hljs-built_in">require</span>(<span class="hljs-string">'bloomrun'</span>),
  SafeStringify = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fast-safe-stringify'</span>),
  Parse = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fast-json-parse'</span>),
  Nats = <span class="hljs-built_in">require</span>(<span class="hljs-string">'nats'</span>),
  Pino = <span class="hljs-built_in">require</span>(<span class="hljs-string">'pino'</span>),
  Errio = <span class="hljs-built_in">require</span>(<span class="hljs-string">'errio'</span>),
  Hoek = <span class="hljs-built_in">require</span>(<span class="hljs-string">'hoek'</span>),
  _ = <span class="hljs-built_in">require</span>(<span class="hljs-string">'lodash'</span>),
  Parambulator = <span class="hljs-built_in">require</span>(<span class="hljs-string">'parambulator'</span>),
  SuperError = <span class="hljs-built_in">require</span>(<span class="hljs-string">'super-error'</span>),
  NUID = <span class="hljs-built_in">require</span>(<span class="hljs-string">'nuid'</span>),
  Pretty = Pino.pretty()

<span class="hljs-comment">/**
 * Constants
 */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Errors messages</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span>
  JSON_PARSE_ERROR = <span class="hljs-string">'Invalid JSON payload'</span>,
  ACT_TIMEOUT_ERROR = <span class="hljs-string">'Timeout'</span>,
  NO_TOPIC_TO_SUBSCRIBE = <span class="hljs-string">'No topic to subscribe'</span>,
  NO_TOPIC_TO_REQUEST = <span class="hljs-string">'No topic to request'</span>,
  PATTERN_ALREADY_IN_USE = <span class="hljs-string">'Pattern is already in use'</span>,
  MISSING_IMPLEMENTATION = <span class="hljs-string">'Missing implementation'</span>,
  INVALID_ERROR_OBJECT = <span class="hljs-string">'No native Error object passed'</span>,
  PATTERN_NOT_FOUND = <span class="hljs-string">'No handler found for this pattern'</span>,
  IMPLEMENTATION_ERROR = <span class="hljs-string">'Bad implementation'</span>,
  PAYLOAD_PARSING_ERROR = <span class="hljs-string">'Invalid payload'</span>,
  PLUGIN_ALREADY_IN_USE = <span class="hljs-string">'Plugin is already registered'</span>,
  TRANSPORT_CONNECTED = <span class="hljs-string">'Connected!'</span>,
  PLUGIN_ADDED = <span class="hljs-string">'PLUGIN - ADDED!'</span>,
  PAYLOAD_VALIDATION_ERROR = <span class="hljs-string">'Invalid payload'</span>,
  ADD_ADDED = <span class="hljs-string">'ADD - ADDED'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Errors</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">var</span>
  HemeraError = SuperError.subclass(<span class="hljs-string">'HemeraError'</span>),
  ParseError = HemeraError.subclass(<span class="hljs-string">'HemeraParseError'</span>),
  TimeoutError = HemeraError.subclass(<span class="hljs-string">'TimeoutError'</span>),
  ImplementationError = HemeraError.subclass(<span class="hljs-string">'ImplementationError'</span>),
  BusinessError = HemeraError.subclass(<span class="hljs-string">'BusinessError'</span>),
  FatalError = HemeraError.subclass(<span class="hljs-string">'FatalError'</span>),
  PatternNotFound = HemeraError.subclass(<span class="hljs-string">'PatternNotFound'</span>),
  PayloadValidationError = SuperError.subclass(<span class="hljs-string">'PayloadValidationError'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Config</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> defaultConfig = {
  <span class="hljs-attr">timeout</span>: <span class="hljs-number">2000</span>,
  <span class="hljs-attr">debug</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">crashOnFatal</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">logLevel</span>: <span class="hljs-string">'silent'</span>
}

<span class="hljs-comment">/**
 * 
 * 
 * @class Hemera
 */</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Hemera</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">EventEmitter</span> </span>{

  <span class="hljs-keyword">constructor</span>(transport, params) {

      <span class="hljs-keyword">super</span>()

      <span class="hljs-keyword">this</span>.catalog = Bloomrun()
      <span class="hljs-keyword">this</span>.config = Hoek.applyToDefaults(defaultConfig, params || {})
      <span class="hljs-keyword">this</span>.transport = transport
      <span class="hljs-keyword">this</span>.events = <span class="hljs-keyword">new</span> Kilt([<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>.transport])
      <span class="hljs-keyword">this</span>.topics = {}
      <span class="hljs-keyword">this</span>.plugins = {}</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Special variables for act and add</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">this</span>.context$ = {}
      <span class="hljs-keyword">this</span>.meta$ = {}
      <span class="hljs-keyword">this</span>.plugin$ = {}</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Leads to too much listeners in tests</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.config.logLevel !== <span class="hljs-string">'silent'</span>) {
        Pretty.pipe(process.stdout)
      }

      <span class="hljs-keyword">this</span>.logger = Pino({
        <span class="hljs-attr">name</span>: <span class="hljs-string">'app'</span>,
        <span class="hljs-attr">safe</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">level</span>: <span class="hljs-keyword">this</span>.config.logLevel
      }, Pretty)

    }
    <span class="hljs-comment">/**
     * 
     * 
     * @param {any} plugin
     * 
     * @memberOf Hemera
     */</span>
  use(params) {

      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.plugins[params.attributes.name]) {
        <span class="hljs-keyword">let</span> error = <span class="hljs-keyword">new</span> HemeraError(PLUGIN_ALREADY_IN_USE)
        <span class="hljs-keyword">this</span>.log().error(error)
        <span class="hljs-keyword">throw</span> (error)
      }

      <span class="hljs-keyword">let</span> delegate = <span class="hljs-keyword">this</span>.delegate()
      delegate.plugin$ = params.attributes
      params.plugin.call(delegate, params.options)

      <span class="hljs-keyword">this</span>.log().info(params.attributes.name, PLUGIN_ADDED)
      <span class="hljs-keyword">this</span>.plugins[params.attributes.name] = delegate.plugin$

    }
    <span class="hljs-comment">/**
     * 
     * 
     * 
     * @memberOf Hemera
     */</span>
  fatal() {

      process.exit(<span class="hljs-number">1</span>)

    }
    <span class="hljs-comment">/**
     * 
     * 
     * @readonly
     * 
     * @memberOf Hemera
     */</span>
  log() {

      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.logger
    }
    <span class="hljs-comment">/**
     * 
     * 
     * @param {any} cb
     * 
     * @memberOf Hemera
     */</span>
  ready(cb) {

      <span class="hljs-keyword">this</span>.events.on(<span class="hljs-string">'connect'</span>, () =&gt; {

        <span class="hljs-keyword">this</span>.log().info(TRANSPORT_CONNECTED)
        cb.call(<span class="hljs-keyword">this</span>)
      })

    }
    <span class="hljs-comment">/**
     * 
     * 
     * @returns
     * 
     * @memberOf Hemera
     */</span>
  timeout() {

      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.transport.timeout.apply(<span class="hljs-keyword">this</span>.transport, <span class="hljs-built_in">arguments</span>)
    }
    <span class="hljs-comment">/**
     * Add response
     * 
     * @returns
     * 
     * @memberOf Hemera
     */</span>
  send() {

      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.transport.publish.apply(<span class="hljs-keyword">this</span>.transport, <span class="hljs-built_in">arguments</span>)
    }
    <span class="hljs-comment">/**
     * Act
     * 
     * @returns
     * 
     * @memberOf Hemera
     */</span>
  sendRequest() {

      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.transport.request.apply(<span class="hljs-keyword">this</span>.transport, <span class="hljs-built_in">arguments</span>)
    }
    <span class="hljs-comment">/**
     * 
     * 
     * @param {any} error
     * @returns
     * 
     * @memberOf Hemera
     */</span>
  buildError(error, additionalData) {

      <span class="hljs-keyword">this</span>.log().error(error)</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>After action is proceed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      additionalData.response$.endTime = <span class="hljs-built_in">Date</span>.now()

      <span class="hljs-keyword">let</span> msg = <span class="hljs-keyword">this</span>.stringifyJSON(Hoek.merge({
        <span class="hljs-attr">result</span>: <span class="hljs-literal">null</span>,
        <span class="hljs-attr">error</span>: Errio.stringify(error)
      }, additionalData))

      <span class="hljs-keyword">return</span> msg

    }
    <span class="hljs-comment">/**
     * 
     * 
     * @param {any} data
     * @returns
     * 
     * @memberOf Hemera
     */</span>
  buildSuccess(data, additionalData) {</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>After action is proceed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      additionalData.response$.endTime = <span class="hljs-built_in">Date</span>.now()

      <span class="hljs-keyword">let</span> msg = <span class="hljs-keyword">this</span>.stringifyJSON(Hoek.merge({
        <span class="hljs-attr">result</span>: data,
        <span class="hljs-attr">error</span>: <span class="hljs-literal">null</span>
      }, additionalData))

      <span class="hljs-keyword">return</span> msg

    }
    <span class="hljs-comment">/**
     * 
     * 
     * @param {any} topic
     * @returns
     * 
     * @memberOf Hemera
     */</span>
  subscribe(topic) {

      <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Avoid duplicate subscribers of the emit stream
We use one subscriber per topic</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (self.topics[topic]) {
        <span class="hljs-keyword">return</span>
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Queue group names allow load balancing of services</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">this</span>.transport.subscribe(topic, {
        <span class="hljs-string">'queue'</span>: <span class="hljs-string">'queue.'</span> + topic
      }, (request, replyTo) =&gt; {

        <span class="hljs-keyword">let</span> additionalResponseData = {</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Log time before request is proceed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          response$: {
            <span class="hljs-attr">startTime</span>: <span class="hljs-built_in">Date</span>.now()
          }
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Parse response as JSON</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">let</span> result = <span class="hljs-keyword">this</span>.parseJSON(request)</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Invalid payload</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (result.error) {

          <span class="hljs-keyword">let</span> error = <span class="hljs-keyword">new</span> ParseError(PAYLOAD_PARSING_ERROR).causedBy(result.error)

          <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.send(replyTo, <span class="hljs-keyword">this</span>.buildError(error, additionalResponseData))
        }

        <span class="hljs-keyword">let</span> actMeta = <span class="hljs-keyword">this</span>.catalog.lookup(result.value.pattern)</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Check if a handler is registered with this pattern</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (actMeta) {</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Pass metadata</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          result = Hoek.merge(result.value.pattern, {
            <span class="hljs-attr">meta$</span>: result.value.meta$,
            <span class="hljs-attr">request$</span>: result.value.request$
          })

          additionalResponseData.meta$ = result.meta$
          additionalResponseData.request$ = result.request$

          <span class="hljs-keyword">try</span> {

            <span class="hljs-keyword">let</span> paramcheck = Parambulator(actMeta.patternRules)</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Validate payload</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            paramcheck.validate(result, (err) =&gt; {

              <span class="hljs-keyword">if</span> (err) {

                <span class="hljs-keyword">let</span> payloadError = <span class="hljs-keyword">new</span> PayloadValidationError(PAYLOAD_VALIDATION_ERROR).causedBy(err)</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Send message</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.send(replyTo, <span class="hljs-keyword">this</span>.buildError(payloadError, additionalResponseData))
              }</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Execute action</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              actMeta.action(result, (err, resp) =&gt; {

                <span class="hljs-keyword">if</span> (err) {

                  <span class="hljs-keyword">let</span> businessError = <span class="hljs-keyword">new</span> BusinessError(IMPLEMENTATION_ERROR).causedBy(err)

                  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.send(replyTo, <span class="hljs-keyword">this</span>.buildError(businessError, additionalResponseData))
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Send message</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">this</span>.send(replyTo, <span class="hljs-keyword">this</span>.buildSuccess(resp, additionalResponseData))
              })

            })

          } <span class="hljs-keyword">catch</span> (err) {

            <span class="hljs-keyword">let</span> error = <span class="hljs-keyword">new</span> ImplementationError(IMPLEMENTATION_ERROR).causedBy(err)</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Send error back to callee</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">this</span>.send(replyTo, <span class="hljs-keyword">this</span>.buildError(error, additionalResponseData), () =&gt; {</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>let it crash</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.config.crashOnFatal) {

                <span class="hljs-keyword">this</span>.fatal()
              }
            })

          }

        } <span class="hljs-keyword">else</span> {

          <span class="hljs-keyword">this</span>.log().info({
            topic
          }, PATTERN_NOT_FOUND)

          <span class="hljs-keyword">let</span> error = <span class="hljs-keyword">new</span> PatternNotFound(PATTERN_NOT_FOUND)</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Send error back to callee</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">this</span>.send(replyTo, <span class="hljs-keyword">this</span>.buildError(error, additionalResponseData))
        }

      })

      self.topics[topic] = <span class="hljs-literal">true</span>

    }
    <span class="hljs-comment">/**
     * 
     * 
     * @param {any} pattern
     * @returns
     * 
     * @memberOf Hemera
     */</span>
  createRequestId(pattern) {

      <span class="hljs-keyword">return</span> NUID.next()
    }
    <span class="hljs-comment">/**
     * 
     * 
     * @param {any} msg
     * @returns
     * 
     * @memberOf Hemera
     */</span>
  parseJSON(msg) {

      <span class="hljs-keyword">return</span> Parse(msg)
    }
    <span class="hljs-comment">/**
     * 
     * 
     * @param {any} msg
     * @returns
     * 
     * @memberOf Hemera
     */</span>
  stringifyJSON(msg) {

      <span class="hljs-keyword">return</span> SafeStringify(msg)
    }
    <span class="hljs-comment">/**
     * 
     * 
     * @param {any} pattern
     * @param {any} cb
     * 
     * @memberOf Hemera
     */</span>
  add(pattern, cb) {</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Topic is needed to subscribe on a subject in NATS</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (!pattern.topic) {

        <span class="hljs-keyword">let</span> error = <span class="hljs-keyword">new</span> HemeraError(NO_TOPIC_TO_SUBSCRIBE)
        <span class="hljs-keyword">this</span>.log().error(error)
        <span class="hljs-keyword">throw</span> (error)
      }

      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> cb !== <span class="hljs-string">'function'</span>) {

        <span class="hljs-keyword">let</span> error = <span class="hljs-keyword">new</span> HemeraError(MISSING_IMPLEMENTATION)
        <span class="hljs-keyword">this</span>.log().error(error)
        <span class="hljs-keyword">throw</span> (error)
      }

      <span class="hljs-keyword">let</span> origPattern = _.cloneDeep(pattern)

      <span class="hljs-keyword">let</span> patternRules = {}</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Remove objects (rules) from pattern</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      _.each(pattern, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">v, k</span>) </span>{
        <span class="hljs-keyword">if</span> (_.isObject(v)) {
          patternRules[k] = _.clone(v)
          <span class="hljs-keyword">delete</span> origPattern[k]
        }
      })</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Create message object which represent the object behind the matched pattern</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">let</span> actMeta = {
        <span class="hljs-attr">patternRules</span>: patternRules,
        <span class="hljs-attr">pattern</span>: origPattern,
        <span class="hljs-attr">action</span>: <span class="hljs-function">(<span class="hljs-params">resp, reply</span>) =&gt;</span> {
          cb.apply(<span class="hljs-keyword">this</span>.delegate(), [resp, reply])
        }
      }

      <span class="hljs-keyword">let</span> handler = <span class="hljs-keyword">this</span>.catalog.lookup(origPattern)</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Check if pattern is already registered</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (handler) {

        <span class="hljs-keyword">let</span> error = <span class="hljs-keyword">new</span> HemeraError(PATTERN_ALREADY_IN_USE)
        <span class="hljs-keyword">this</span>.log().error(error)
        <span class="hljs-keyword">throw</span> (error)
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Add to bloomrun</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">this</span>.catalog.add(origPattern, actMeta)

      <span class="hljs-keyword">this</span>.log().info(pattern, ADD_ADDED)</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Subscribe on topic</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">this</span>.subscribe(pattern.topic)

    }
    <span class="hljs-comment">/**
     * 
     * 
     * 
     * @memberOf Hemera
     */</span>
  cleanPattern(obj) {

      <span class="hljs-keyword">if</span> (obj === <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> obj

      <span class="hljs-keyword">return</span> _.pickBy(obj, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">val, prop</span>) </span>{
        <span class="hljs-keyword">return</span> !_.includes(prop, <span class="hljs-string">'$'</span>)
      })
    }
    <span class="hljs-comment">/**
     * 
     * 
     * @param {any} pattern
     * @param {any} cb
     * 
     * @memberOf Hemera
     */</span>
  act(pattern, cb) {</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Topic is needed to subscribe on a subject in NATS</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (!pattern.topic) {

        <span class="hljs-keyword">let</span> error = <span class="hljs-keyword">new</span> HemeraError(NO_TOPIC_TO_REQUEST)
        <span class="hljs-keyword">this</span>.log().error(error)
        <span class="hljs-keyword">throw</span> (error)
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Create delegate</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">let</span> delegate = <span class="hljs-keyword">this</span>.delegate()</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Set context by pattern or current configuration</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      delegate.context$ = pattern.context$ || <span class="hljs-keyword">this</span>.context$</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Set metadata by pattern or previous delegate</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      delegate.meta$ = pattern.meta$ || delegate.meta$</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Create unique reqeuest id</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      delegate.requestId$ = <span class="hljs-keyword">this</span>.createRequestId()</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>clean special $ variables</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">let</span> cleanPattern = <span class="hljs-keyword">this</span>.cleanPattern(pattern)</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Parse msg as JSON</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">let</span> msg = {
        <span class="hljs-attr">pattern</span>: cleanPattern,
        <span class="hljs-attr">meta$</span>: delegate.meta$,
        <span class="hljs-attr">request$</span>: {
          <span class="hljs-attr">id</span>: delegate.requestId$,
          <span class="hljs-attr">startTime</span>: <span class="hljs-built_in">Date</span>.now()
        }
      }

      <span class="hljs-keyword">this</span>.log().info(pattern, <span class="hljs-string">'ACT_OUTBOUND'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Emit event</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'outbound'</span>, msg)</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Request to topic</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">let</span> sid = <span class="hljs-keyword">this</span>.sendRequest(pattern.topic, <span class="hljs-keyword">this</span>.stringifyJSON(msg), (response) =&gt; {</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Parse response as JSON</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">let</span> msg = <span class="hljs-keyword">this</span>.parseJSON(response)

        <span class="hljs-keyword">try</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>If payload is invalid</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> (msg.error) {

            <span class="hljs-keyword">let</span> error = <span class="hljs-keyword">new</span> ParseError(PAYLOAD_PARSING_ERROR).causedBy(msg.error)
            <span class="hljs-keyword">this</span>.log().error(error)

            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> cb === <span class="hljs-string">'function'</span>) {
              <span class="hljs-keyword">return</span> cb(error)
            }
          }</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Check if request$ was successfully transfered</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> (!msg.value.request$) {

            msg.value.request$ = {
              <span class="hljs-attr">endTime</span>: <span class="hljs-built_in">Date</span>.now()
            }
          } <span class="hljs-keyword">else</span> {

            msg.value.request$.endTime = <span class="hljs-built_in">Date</span>.now()
          }</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Emit event</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'inbound'</span>, msg.value)

          <span class="hljs-keyword">this</span>.log().info(pattern, <span class="hljs-string">'ACT_INBOUND'</span>)

          <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> cb === <span class="hljs-string">'function'</span>) {

            <span class="hljs-keyword">if</span> (msg.value.error) {

              <span class="hljs-keyword">let</span> error = <span class="hljs-keyword">new</span> BusinessError().causedBy(Errio.parse(msg.value.error))
              <span class="hljs-keyword">this</span>.log().error(error)</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>error is already wrapped</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="hljs-keyword">return</span> cb.call(delegate, Errio.parse(msg.value.error))
            }

            cb.apply(delegate, [<span class="hljs-literal">null</span>, msg.value.result])
          }

        } <span class="hljs-keyword">catch</span> (err) {

          <span class="hljs-keyword">let</span> error = <span class="hljs-keyword">new</span> FatalError().causedBy(err)
          <span class="hljs-keyword">this</span>.log().fatal(error)</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Let it crash</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.config.crashOnFatal) {

            <span class="hljs-keyword">this</span>.fatal()
          }
        }

      })</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Handle timeout</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">this</span>.timeout(sid, pattern.timeout$ || <span class="hljs-keyword">this</span>.config.timeout, <span class="hljs-number">1</span>, () =&gt; {

        <span class="hljs-keyword">let</span> error = <span class="hljs-keyword">new</span> TimeoutError(ACT_TIMEOUT_ERROR)
        <span class="hljs-keyword">this</span>.log().error(error, pattern)

        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> cb === <span class="hljs-string">'function'</span>) {

          <span class="hljs-keyword">try</span> {

            cb(error)
          } <span class="hljs-keyword">catch</span> (err) {

            <span class="hljs-keyword">let</span> error = <span class="hljs-keyword">new</span> FatalError().causedBy(err)
            <span class="hljs-keyword">this</span>.log().fatal(error)</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>Let it crash</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.config.crashOnFatal) {

              <span class="hljs-keyword">this</span>.fatal()
            }

          }
        }

      })

    }
    <span class="hljs-comment">/**
     * 
     * 
     * @returns
     * 
     * @memberOf Hemera
     */</span>
  delegate() {

      <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span></pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>Create new instance of hemera but with pointer on the previous propertys
So we are able to create a scope per act without lossing the reference to the core api.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> delegate = <span class="hljs-built_in">Object</span>.create(self)
      delegate.context$ = self.context$
      delegate.meta$ = self.meta$
      delegate.plugin$ = self.plugin$

      <span class="hljs-keyword">return</span> delegate
    }
    <span class="hljs-comment">/**
     * 
     * 
     * 
     * @memberOf Hemera
     */</span>
  list(params) {

      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.catalog.list(params)

    }
    <span class="hljs-comment">/**
     * 
     * 
     * @returns
     * 
     * @memberOf Hemera
     */</span>
  close() {

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.transport.close()

  }

}

<span class="hljs-built_in">module</span>.exports = Hemera</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
