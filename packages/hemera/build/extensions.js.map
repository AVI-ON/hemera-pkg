{"version":3,"sources":["../lib/extensions.js"],"names":["module","exports","onClientPreRequest","next","ctx","pattern","_pattern","prevCtx","_prevContext","cleanPattern","_cleanPattern","currentTime","nowHrTime","context$","meta$","merge","delegate$","trace$","parentSpanId","spanId","traceId","randomId","timestamp","service","topic","method","request","id","requestId$","parentId","request$","type","pubsub$","duration","message","meta","delegate","trace","_message","log","info","String","emit","onClientPostRequest","msg","_response","payload","onServerPreRequest","req","res","m","_decoder","decode","call","_request","error","send","value","onServerPreHandler","onServerPreResponse"],"mappings":"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","file":"extensions.js","sourcesContent":["// @flow\r\n\r\n/*!\r\n * hemera\r\n * Copyright(c) 2016 Dustin Deus (deusdustin@gmail.com)\r\n * MIT Licensed\r\n */\r\n\r\nimport Util from './util'\r\nimport Hoek from 'hoek'\r\n\r\nmodule.exports.onClientPreRequest = [function onClientPreRequest(next: Function) {\r\n\r\n  let ctx: Hemera = this\r\n\r\n  let pattern: Pattern = this._pattern\r\n\r\n  let prevCtx = this._prevContext\r\n  let cleanPattern = this._cleanPattern\r\n  let currentTime = Util.nowHrTime()\r\n\r\n  // shared context\r\n  ctx.context$ = pattern.context$ || prevCtx.context$\r\n\r\n  // set metadata by passed pattern or current message context\r\n  ctx.meta$ = Hoek.merge(pattern.meta$ || {}, ctx.meta$)\r\n  // is only passed by msg\r\n  ctx.delegate$ = pattern.delegate$ || {}\r\n\r\n  // tracing\r\n  ctx.trace$ = pattern.trace$ || {}\r\n  ctx.trace$.parentSpanId = prevCtx.trace$.spanId\r\n  ctx.trace$.traceId = prevCtx.trace$.traceId || Util.randomId()\r\n  ctx.trace$.spanId = pattern.trace$ ? pattern.trace$.spanId : Util.randomId()\r\n  ctx.trace$.timestamp = currentTime\r\n  ctx.trace$.service = pattern.topic\r\n  ctx.trace$.method = Util.pattern(pattern)\r\n\r\n  // request\r\n  let request: Request = {\r\n    id: pattern.requestId$ || Util.randomId(),\r\n    parentId: ctx.request$.id,\r\n    timestamp: currentTime,\r\n    type: pattern.pubsub$ === true ? 'pubsub' : 'request',\r\n    duration: 0\r\n  }\r\n\r\n  // build msg\r\n  let message: ActMessage = {\r\n    pattern: cleanPattern,\r\n    meta: ctx.meta$,\r\n    delegate: ctx.delegate$,\r\n    trace: ctx.trace$,\r\n    request: request\r\n  }\r\n\r\n  ctx._message = message\r\n\r\n  ctx.log.info(pattern, `ACT_OUTBOUND - ID:${String(ctx._message.request.id)}`)\r\n\r\n  ctx.emit('onClientPreRequest', ctx)\r\n\r\n  next()\r\n}]\r\n\r\nmodule.exports.onClientPostRequest = [function onClientPostRequest(next: Function) {\r\n\r\n  let ctx: Hemera = this\r\n  let pattern: Pattern = this._pattern\r\n  let msg = ctx._response.payload\r\n\r\n  // pass to act context\r\n  ctx.request$ = msg.request || {}\r\n  ctx.request$.service = pattern.topic\r\n  ctx.request$.method = Util.pattern(pattern)\r\n  ctx.trace$ = msg.trace || {}\r\n  ctx.meta$ = msg.meta || {}\r\n\r\n  ctx.log.info(`ACT_INBOUND - ID:${ctx.request$.id} (${ctx.request$.duration / 1000000}ms)`)\r\n\r\n  ctx.emit('onClientPostRequest', ctx)\r\n\r\n  next()\r\n}]\r\n\r\nmodule.exports.onServerPreRequest = [function onServerPreRequest(req: any, res: any, next: Function) {\r\n\r\n  let ctx: Hemera = this\r\n\r\n  let m = ctx._decoder.decode.call(ctx, ctx._request.payload)\r\n\r\n  if(m.error) {\r\n\r\n    return res.send(m.error)\r\n  }\r\n\r\n  let msg = m.value\r\n\r\n  if (msg) {\r\n\r\n    ctx.meta$ = msg.meta || {}\r\n    ctx.trace$ = msg.trace || {}\r\n    ctx.delegate$ = msg.delegate || {}\r\n    ctx.request$ = msg.request || {}\r\n  }\r\n\r\n  ctx._request.payload = m.value\r\n  ctx._request.error = m.error\r\n\r\n  ctx.emit('onServerPreRequest', ctx)\r\n\r\n  next()\r\n}]\r\n\r\nmodule.exports.onServerPreHandler = [function onServerPreHandler(req: any, res: any, next: Function) {\r\n\r\n  let ctx: Hemera = this\r\n\r\n  ctx.emit('onServerPreHandler', ctx)\r\n\r\n  next()\r\n\r\n}]\r\n\r\nmodule.exports.onServerPreResponse = [function onServerPreResponse(req: any, res: any, next: Function) {\r\n\r\n  let ctx: Hemera = this\r\n\r\n  ctx.emit('onServerPreResponse', ctx)\r\n\r\n  next()\r\n\r\n}]\r\n"]}