{"version":3,"sources":["../lib/encoder.js"],"names":["Encoder","msg","value","stringify","error","obj","decirc","JSON","Circle","val","k","parent","count","prototype","toJSON","stack","keys","len","i","indexOf","push","Object","length","pop"],"mappings":";;;;;;;;;;AAAA;;;;;;;IAOqBA,O;;;;;;;2BAEJC,G,EAAK;AAClB,UAAI;AACF,eAAO;AACLC,iBAAOC,UAAUF,GAAV;AADF,SAAP;AAGD,OAJD,CAIE,OAAOG,KAAP,EAAc;AACd,eAAO;AACLA;AADK,SAAP;AAGD;AACF;;;;;;kBAZkBJ,O;;;AAerB,SAASG,SAAT,CAAoBE,GAApB,EAAyB;AACvBC,SAAOD,GAAP,EAAY,EAAZ,EAAgB,EAAhB,EAAoB,IAApB;AACA,SAAOE,KAAKJ,SAAL,CAAeE,GAAf,CAAP;AACD;;AAED,SAASG,MAAT,CAAiBC,GAAjB,EAAsBC,CAAtB,EAAyBC,MAAzB,EAAiC;AAC/B,OAAKF,GAAL,GAAWA,GAAX;AACA,OAAKC,CAAL,GAASA,CAAT;AACA,OAAKC,MAAL,GAAcA,MAAd;AACA,OAAKC,KAAL,GAAa,CAAb;AACD;;AAEDJ,OAAOK,SAAP,CAAiBC,MAAjB,GAA0B,SAASA,MAAT,GAAmB;AAC3C,MAAI,EAAE,KAAKF,KAAP,KAAiB,CAArB,EAAwB;AACtB,SAAKD,MAAL,CAAY,KAAKD,CAAjB,IAAsB,KAAKD,GAA3B;AACD;AACD,SAAO,YAAP;AACD,CALD;;AAOA,SAASH,MAAT,CAAiBG,GAAjB,EAAsBC,CAAtB,EAAyBK,KAAzB,EAAgCJ,MAAhC,EAAwC;AACtC,MAAIK,IAAJ,EAAUC,GAAV,EAAeC,CAAf;;AAEA,MAAI,OAAOT,GAAP,KAAe,QAAf,IAA2BA,QAAQ,IAAvC,EAA6C;AAC3C;AACA;AACD,GAHD,MAGO,IAAIA,eAAeD,MAAnB,EAA2B;AAChCC,QAAIG,KAAJ;AACA;AACD,GAHM,MAGA,IAAID,MAAJ,EAAY;AACjB,QAAI,CAACI,MAAMI,OAAN,CAAcV,GAAd,CAAL,EAAyB;AACvBE,aAAOD,CAAP,IAAY,IAAIF,MAAJ,CAAWC,GAAX,EAAgBC,CAAhB,EAAmBC,MAAnB,CAAZ;AACA;AACD;AACF;;AAEDI,QAAMK,IAAN,CAAWX,GAAX;AACAO,SAAOK,OAAOL,IAAP,CAAYP,GAAZ,CAAP;AACAQ,QAAMD,KAAKM,MAAX;AACAJ,MAAI,CAAJ;;AAEA,SAAOA,IAAID,GAAX,EAAgBC,GAAhB,EAAqB;AACnBR,QAAIM,KAAKE,CAAL,CAAJ;AACAZ,WAAOG,IAAIC,CAAJ,CAAP,EAAeA,CAAf,EAAkBK,KAAlB,EAAyBN,GAAzB;AACD;AACDM,QAAMQ,GAAN;AACD","file":"encoder.js","sourcesContent":["/*!\r\n * hemera\r\n * Copyright(c) 2016 Dustin Deus (deusdustin@gmail.com)\r\n * MIT Licensed\r\n * Based on https://github.com/davidmarkclements/fast-safe-stringify\r\n */\r\n\r\nexport default class Encoder {\r\n\r\n  static encode (msg) {\r\n    try {\r\n      return {\r\n        value: stringify(msg)\r\n      }\r\n    } catch (error) {\r\n      return {\r\n        error\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nfunction stringify (obj) {\r\n  decirc(obj, '', [], null)\r\n  return JSON.stringify(obj)\r\n}\r\n\r\nfunction Circle (val, k, parent) {\r\n  this.val = val\r\n  this.k = k\r\n  this.parent = parent\r\n  this.count = 1\r\n}\r\n\r\nCircle.prototype.toJSON = function toJSON () {\r\n  if (--this.count === 0) {\r\n    this.parent[this.k] = this.val\r\n  }\r\n  return '[Circular]'\r\n}\r\n\r\nfunction decirc (val, k, stack, parent) {\r\n  var keys, len, i\r\n\r\n  if (typeof val !== 'object' || val === null) {\r\n    // not an object, nothing to do\r\n    return\r\n  } else if (val instanceof Circle) {\r\n    val.count++\r\n    return\r\n  } else if (parent) {\r\n    if (~stack.indexOf(val)) {\r\n      parent[k] = new Circle(val, k, parent)\r\n      return\r\n    }\r\n  }\r\n\r\n  stack.push(val)\r\n  keys = Object.keys(val)\r\n  len = keys.length\r\n  i = 0\r\n\r\n  for (; i < len; i++) {\r\n    k = keys[i]\r\n    decirc(val[k], k, stack, val)\r\n  }\r\n  stack.pop()\r\n}\r\n"]}